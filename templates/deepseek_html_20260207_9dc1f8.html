{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Top Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <h1>Hello, {{ session.full_name }}</h1>
            <p class="welcome-text">Welcome to your dashboard</p>
        </div>
        <div class="header-right">
            <!-- âœ… LINE 12 UPDATED FOR CLOUDINARY -->
            <img src="{{ session.profile_pic }}" 
                 alt="Profile" class="profile-pic" 
                 onerror="this.src='{{ url_for('static', filename='default-avatar.jpg') }}'">
        </div>
    </header>

    <!-- Welcome Popup Modal -->
    <div class="welcome-modal-overlay" id="welcomeModal">
        <div class="welcome-modal">
            <button class="close-modal" onclick="closeWelcomeModal()">&times;</button>
            
            <div class="modal-content">
                <!-- Profile Photo at Top -->
                <div class="profile-photo-top">
                    {% if session.profile_pic and session.profile_pic != url_for('static', filename='default-avatar.jpg') %}
                    <img src="{{ session.profile_pic }}" 
                         alt="Profile" 
                         class="top-profile-img"
                         onerror="this.style.display='none'; document.querySelector('.top-profile-empty').style.display='flex';">
                    <div class="top-profile-empty" style="display: none;">
                        <i class="fas fa-user"></i>
                    </div>
                    {% else %}
                    <div class="top-profile-empty">
                        <i class="fas fa-user"></i>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Only Welcome Card (No Extra Content) -->
                <div class="welcome-card-only">
                    <div class="welcome-message-only">Welcome Back!</div>
                    <div class="customer-name-only">{{ session.full_name }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <div class="content-placeholder">
            <div class="placeholder-icon">
                <i class="fas fa-home"></i>
            </div>
            <h2>Welcome to Your Dashboard</h2>
            <p>Use the bottom navigation to explore services, menu, cart, orders, and profile.</p>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="{{ url_for('services') }}" class="nav-item" data-page="services">
            <i class="fas fa-concierge-bell"></i>
            <span>Services</span>
        </a>
        <a href="{{ url_for('menu') }}" class="nav-item" data-page="menu">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="{{ url_for('cart') }}" class="nav-item" data-page="cart">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
        <a href="{{ url_for('order_history') }}" class="nav-item" data-page="orders">
            <i class="fas fa-history"></i>
            <span>Orders</span>
        </a>
        <a href="{{ url_for('profile') }}" class="nav-item" data-page="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>
</div>

<style>
/* Welcome Modal Styles - Simplified and Transparent */
.welcome-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.welcome-modal {
    background: transparent;
    border-radius: 0;
    padding: 0;
    position: relative;
    max-width: 300px;
    width: 90%;
    box-shadow: none;
    animation: modalAppear 0.5s ease;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.close-modal {
    position: absolute;
    top: -40px;
    right: -10px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #333;
    transition: all 0.3s;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

.close-modal:hover {
    background: white;
    color: #000;
    transform: scale(1.1);
}

.modal-content {
    text-align: center;
    padding: 0;
    width: 100%;
}

/* Profile Photo at Top - Circular with Border */
.profile-photo-top {
    width: 100px;
    height: 100px;
    margin: 0 auto 10px; /* 10px bottom margin for spacing */
    position: relative;
}

.top-profile-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid rgba(255, 255, 255, 0.9);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    background: white;
}

.top-profile-empty {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 4px dashed rgba(255, 255, 255, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

.top-profile-empty i {
    font-size: 40px;
    color: rgba(0, 0, 0, 0.4);
}

/* Only Welcome Card - Everything else transparent */
.welcome-card-only {
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    padding: 25px 20px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    margin-top: 10px; /* Added 10px top margin for spacing from circle */
}

.welcome-card-only::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.welcome-message-only {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #667eea;
    position: relative;
    z-index: 1;
}

.customer-name-only {
    font-size: 22px;
    font-weight: 700;
    color: #333;
    position: relative;
    z-index: 1;
}

/* Make everything else in modal transparent except the card */
.welcome-modal > *:not(.welcome-card-only) {
    background: transparent;
}

.welcome-modal.hiding {
    opacity: 0;
    transform: translateY(-20px);
}
</style>

<script>
// Handle navigation and load content via AJAX
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
        if (this.getAttribute('href').startsWith('#')) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            loadPage(page);
        }
    });
});

function loadPage(page) {
    const mainContent = document.getElementById('mainContent');
    
    // Remove active class from all nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Add active class to clicked item
    event.target.closest('.nav-item').classList.add('active');
    
    // You can implement AJAX loading here if needed
    // For now, we'll rely on full page loads from Flask routes
}

// Welcome Modal Functions
let autoCloseTimer;

function showWelcomeModal() {
    const modal = document.getElementById('welcomeModal');
    if (modal) {
        modal.style.display = 'flex';
        
        // Auto close after 5 seconds
        autoCloseTimer = setTimeout(() => {
            closeWelcomeModal();
        }, 5000);
    }
}

function closeWelcomeModal() {
    const modal = document.getElementById('welcomeModal');
    if (modal) {
        clearTimeout(autoCloseTimer);
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

// Show modal when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if this is a fresh visit (not from navigation)
    if (sessionStorage.getItem('welcomeModalShown') !== 'true') {
        setTimeout(() => {
            showWelcomeModal();
            sessionStorage.setItem('welcomeModalShown', 'true');
        }, 500); // Small delay for better UX
    }
});

// Close modal when clicking outside
document.getElementById('welcomeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeWelcomeModal();
    }
});

// Close with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeWelcomeModal();
    }
});
</script>
{% endblock %}