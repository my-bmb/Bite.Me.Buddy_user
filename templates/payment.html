<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - Bite Me Buddy</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* ... à¤¸à¤¾à¤°à¤¾ CSS à¤ªà¤¹à¤²à¥‡ à¤œà¥ˆà¤¸à¤¾ à¤¹à¥€ ... */
    </style>
</head>
<body>
    <div class="payment-card">
        <!-- ... HTML content à¤ªà¤¹à¤²à¥‡ à¤œà¥ˆà¤¸à¤¾ à¤¹à¥€ ... -->
    </div>
    <script>
        const orderNo = "{{ order_no }}";
        const amount = {{ amount }};
        const razorpayKeyId = "{{ razorpay_key_id }}";
        let isProcessing = false;
        let rzpInstance = null;
        let moreOptionsClicked = false;

        // Money emoji animation function
        function createMoneyAnimation() {
            const container = document.getElementById('moneyAnimation');
            container.style.display = 'block';
            const emojis = ['ðŸ’°', 'ðŸ’¸', 'ðŸ’µ', 'ðŸ’´', 'ðŸ’¶', 'ðŸ’·', 'ðŸª™', 'ðŸ’Ž'];
            
            for(let i = 0; i < 20; i++) {
                const emoji = document.createElement('div');
                emoji.className = 'money-emoji';
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.left = Math.random() * 100 + 'vw';
                emoji.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(emoji);
                
                setTimeout(() => {
                    emoji.remove();
                }, 1500);
            }
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 2000);
        }

        function showError(m) {
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = m;
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }
        
        function showProcessing() {
            document.getElementById('paymentProcessing').style.display = 'block';
            document.getElementById('payButton').style.display = 'none';
        }
        
        function hideProcessing() {
            document.getElementById('paymentProcessing').style.display = 'none';
            document.getElementById('payButton').style.display = 'block';
        }
        
        function showSuccessAnimation() {
            document.getElementById('successAnimation').style.display = 'block';
            document.getElementById('paymentProcessing').style.display = 'none';
            createMoneyAnimation();
        }

        // FAST Function to automatically click "More Options"
        function autoClickMoreOptions() {
            console.log('ðŸ” FAST: Looking for "More Options"...');
            moreOptionsClicked = false;
            
            // Strategy 1: QUICK - Direct DOM search (fastest)
            function quickSearch() {
                // Look for any element that might be the "More Options" button
                const selectors = [
                    'button:contains("More")',
                    'button:contains("Options")',
                    'button:contains("more")',
                    'button:contains("options")',
                    '[aria-label*="More"]',
                    '[aria-label*="Options"]',
                    '.methods-toggle',
                    '.show-methods',
                    '[class*="method-toggle"]',
                    '[class*="show-option"]',
                    'div[role="button"]:contains("More")',
                    'a[role="button"]:contains("More")',
                    '.razorpay-container button',
                    '.modal button',
                    'iframe ~ button'
                ];
                
                // Try to find in main document first
                for (let selector of selectors) {
                    try {
                        // Simple text search in buttons
                        const buttons = document.querySelectorAll('button, [role="button"], a, div');
                        for (let btn of buttons) {
                            const text = (btn.textContent || btn.innerText || btn.getAttribute('aria-label') || '').toLowerCase();
                            if (text.includes('more') || text.includes('options') || text.includes('â‹®')) {
                                console.log('âœ… FAST: Found button with text:', text);
                                btn.click();
                                moreOptionsClicked = true;
                                return true;
                            }
                        }
                    } catch(e) {}
                }
                return false;
            }
            
            // Strategy 2: FAST IFRAME search
            function searchIframes() {
                const iframes = document.querySelectorAll('iframe');
                for (let iframe of iframes) {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const buttons = iframeDoc.querySelectorAll('button, [role="button"]');
                        for (let btn of buttons) {
                            const text = (btn.textContent || btn.innerText || '').toLowerCase();
                            if (text.includes('more') || text.includes('options')) {
                                console.log('âœ… FAST: Found in iframe:', text);
                                btn.click();
                                moreOptionsClicked = true;
                                return true;
                            }
                        }
                    } catch(e) {}
                }
                return false;
            }
            
            // Strategy 3: FAST - Simulate key presses (Escape then Tab)
            function simulateKeys() {
                console.log('âŒ¨ï¸ FAST: Simulating Escape+Tab keys');
                // Press Escape to ensure focus
                const escEvent = new KeyboardEvent('keydown', {
                    key: 'Escape',
                    code: 'Escape',
                    keyCode: 27,
                    which: 27,
                    bubbles: true
                });
                document.dispatchEvent(escEvent);
                
                // Then Tab to navigate
                setTimeout(() => {
                    const tabEvent = new KeyboardEvent('keydown', {
                        key: 'Tab',
                        code: 'Tab',
                        keyCode: 9,
                        which: 9,
                        bubbles: true
                    });
                    document.dispatchEvent(tabEvent);
                }, 50);
                
                moreOptionsClicked = true;
                return true;
            }
            
            // Strategy 4: FAST - Click on any Razorpay element with "methods"
            function clickMethods() {
                const elements = document.querySelectorAll('[class*="method"], [class*="Method"]');
                for (let el of elements) {
                    if (el.offsetWidth > 0 && el.offsetHeight > 0) {
                        console.log('ðŸ–±ï¸ FAST: Clicking methods element');
                        el.click();
                        moreOptionsClicked = true;
                        return true;
                    }
                }
                return false;
            }
            
            // Strategy 5: ULTRA FAST - Try all immediately
            function ultraFastSearch() {
                console.log('âš¡ ULTRA FAST: Trying all strategies at once');
                
                // Try quick search
                if (quickSearch()) return true;
                
                // Try iframe search
                if (searchIframes()) return true;
                
                // Try clicking methods
                if (clickMethods()) return true;
                
                // Last resort: simulate keys
                simulateKeys();
                return true;
            }
            
            // Execute ULTRA FAST search immediately
            ultraFastSearch();
            
            // If still not clicked, try again 3 more times quickly
            let attempts = 1;
            const fastInterval = setInterval(() => {
                attempts++;
                console.log(`âš¡ FAST Retry ${attempts}...`);
                
                if (quickSearch() || searchIframes() || clickMethods()) {
                    clearInterval(fastInterval);
                    return;
                }
                
                if (attempts >= 3) {
                    console.log('âš ï¸ FAST: Could not find after 3 attempts');
                    clearInterval(fastInterval);
                    // Final attempt with keys
                    simulateKeys();
                }
            }, 300); // Every 300ms - VERY FAST
        }

        function openRazorpayWithAutoClick() {
            if (isProcessing) return;
            isProcessing = true;
            moreOptionsClicked = false;
            
            // Show processing animation
            showProcessing();

            // Create order on server
            fetch('/create_razorpay_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: amount, order_no: orderNo })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    // Razorpay options
                    const options = {
                        "key": razorpayKeyId,
                        "amount": d.amount,
                        "currency": d.currency,
                        "name": "Bite Me Buddy",
                        "description": `Order No: #${orderNo}`,
                        "image": "/static/logo.png",
                        "order_id": d.order_id,
                        "handler": function(r) { 
                            verifyPayment(r);
                        },
                        "prefill": {
                            "name": "{{ session.get('full_name', '') }}",
                            "email": "{{ session.get('email', '') }}",
                            "contact": "{{ session.get('phone', '') }}"
                        },
                        "notes": {
                            "order_no": orderNo,
                            "user_id": "{{ session.get('user_id', '') }}"
                        },
                        "theme": { 
                            "color": "#4f46e5"
                        },
                        // Enable ALL payment methods
                        "method": {
                            "netbanking": true,
                            "card": true,
                            "wallet": true,
                            "upi": true,
                            "emi": true,
                            "paylater": true
                        },
                        // Modal configuration - NO ANIMATION for faster load
                        "modal": {
                            "ondismiss": function() {
                                isProcessing = false;
                                hideProcessing();
                            },
                            "animation": false, // NO ANIMATION = FASTER
                            "backdropclose": true
                        }
                    };
                    
                    console.log('ðŸš€ Opening Razorpay...');
                    // Create and open Razorpay
                    rzpInstance = new Razorpay(options);
                    
                    // Listen for modal open event if possible
                    rzpInstance.on('modal.open', function() {
                        console.log('âœ… Razorpay modal opened');
                        // Try to click immediately
                        setTimeout(autoClickMoreOptions, 100); // Only 100ms wait!
                    });
                    
                    rzpInstance.open();
                    
                    // ULTRA FAST: Try to click after VERY SHORT delay
                    setTimeout(() => {
                        if (!moreOptionsClicked) {
                            console.log('âš¡ ULTRA FAST: Auto-click attempt');
                            autoClickMoreOptions();
                        }
                    }, 300); // Only 300ms wait!
                    
                    // Backup attempt
                    setTimeout(() => {
                        if (!moreOptionsClicked) {
                            console.log('ðŸ”„ Backup click attempt');
                            autoClickMoreOptions();
                        }
                    }, 1000);
                    
                } else {
                    throw new Error(d.message || 'Failed to create order');
                }
            })
            .catch(e => {
                console.error(e);
                showError('Payment gateway error: ' + e.message);
                isProcessing = false;
                hideProcessing();
            });
        }

        function verifyPayment(r) {
            showSuccessAnimation();
            
            const b = document.getElementById('payButton');
            b.innerHTML = '<span>Verifying...</span>' + '<span class="loading" id="loadingSpinner"></span>';

            fetch('/verify_razorpay_payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    razorpay_payment_id: r.razorpay_payment_id,
                    razorpay_order_id: r.razorpay_order_id,
                    razorpay_signature: r.razorpay_signature,
                    order_no: orderNo
                })
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    setTimeout(() => {
                        window.location.href = `/payment_success?payment_id=${r.razorpay_payment_id}&order_no=${orderNo}`;
                    }, 1500);
                } else {
                    throw new Error(d.message || 'Verification failed');
                }
            })
            .catch(e => {
                console.error(e);
                showError('Payment verification failed');
                window.location.href = `/payment_failed?order_no=${orderNo}&reason=${encodeURIComponent(e.message)}`;
            });
        }

        // Attach click event to pay button
        document.getElementById('payButton').addEventListener('click', openRazorpayWithAutoClick);
        
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN', { 
            day: 'numeric', 
            month: 'short', 
            year: 'numeric' 
        });
        
        // Add button effects
        const payBtn = document.getElementById('payButton');
        payBtn.addEventListener('mousedown', function() {
            this.style.transform = 'scale(0.98)';
        });
        payBtn.addEventListener('mouseup', function() {
            this.style.transform = 'translateY(-1px)';
        });
        payBtn.addEventListener('mouseleave', function() {
            this.style.transform = '';
        });
        
        // PRE-LOAD Razorpay for even faster opening
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âš¡ Pre-loading Razorpay...');
            // Pre-initialize Razorpay for faster opening
            setTimeout(() => {
                fetch('/create_razorpay_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, order_no: orderNo, preload: true })
                }).catch(() => {}); // Silent pre-load
            }, 1000);
        });
    </script>
</body>
</html>
